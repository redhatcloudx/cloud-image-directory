# image data, apply a json schema and publish it together with the API
# endpoint.
name: Container-Release

on:
  push:
    branches:
      - add-release-workflow
  #   tags:
  #     - '*.*.*'

jobs:
  setup:
    steps:
      - name: Install rhelocator
        uses: jaxxstorm/action-install-gh-release@v1.5.0
        with:
          repo: redhatcloudx/rhelocator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  regions:
    needs: setup
    name: Get a list of aws regions
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    outputs:
      aws_region_list: ${{ steps.aws-list.outputs.list }}
    steps:
      - id: aws-list
        run: |
          AWS_REGIONS=$(poetry run python ./src/rhelocator/cli.py aws-regions)
          echo ::set-output name=list::AWS_REGIONS
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  images:
    name: Create AWS image resource
    needs: regions
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      list: ${{ fromJson(needs.regions.outputs.aws_region_list) }}
    steps:
      - run: |
          for region in $list; do
            aws_hourly_images --region $region
          done
